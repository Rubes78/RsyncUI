
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Select Folder</title>
    <style>
        body { font-family: sans-serif; padding: 1em; }
        ul { list-style: none; padding: 0; }
        li { margin: 4px 0; }
        a { text-decoration: none; color: blue; }
        .folder { font-weight: bold; }
    </style>
</head>
<body>
    <h3>Select a Folder</h3>
    <div id="currentPath"></div>
    <ul id="folderList"></ul>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const field = urlParams.get("field");
        let path = "/";

        function fetchFolders(targetPath) {
            fetch(`/browse-folder?path=${encodeURIComponent(targetPath)}&field=${field}`)
                .then(response => response.json())
                .then(data => {
                    path = data.path;
                    document.getElementById("currentPath").innerText = "Current: " + data.path;

                    const list = document.getElementById("folderList");
                    list.innerHTML = "";

                    if (data.path !== "/") {
                        const up = document.createElement("li");
                        up.innerHTML = `<a href="#" onclick="fetchFolders('${data.parent}')">[..]</a>`;
                        list.appendChild(up);
                    }

                    data.folders.forEach(folder => {
                        const li = document.createElement("li");
                        const clean = folder.replace(/\/g, "/");
                        li.innerHTML = `<a href="#" onclick="fetchFolders('${clean}')">${folder.split("/").pop()}</a> 
                                        <button onclick="selectFolder('${clean}')">Select</button>`;
                        list.appendChild(li);
                    });
                });
        }

        function selectFolder(folderPath) {
            if (window.opener && field) {
                const input = window.opener.document.getElementById(field + "Path");
                if (input) {
                    input.value = folderPath;
                }
                window.close();
            }
        }

        fetchFolders("/");
    </script>
</body>
</html>
